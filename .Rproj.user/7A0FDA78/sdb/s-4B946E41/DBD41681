{
    "collab_server" : "",
    "contents" : "######################################################\n#####     Proyeccion Afiliados por Provincia     #####\n######################################################\n\nlibrary('readxl')\nlibrary('dplyr')\nlibrary('tidyr')\n\ndevtools::install_github(\"garrettgman/DSR\")\nlibrary('DSR')\n\n\n#data <- read_excel(\"Activos.xlsx\", sheet = 1)\ndata <- read_excel(\"Cotizantes.xlsx\", sheet = 1)\ndata <- data %>% select(-Periodo)\nglimpse(data)\n\ndata <- ts(data, start = c(2005), frequency = 12)\ncdata <- data \ndata <- ts(data[1:120,], start = c(2005), frequency = 12) # retiramos ultimos 12 meses\n\n# stl(nottem, s.window=\"periodic\")$time.series[,\"trend\"]\nplot(decompose(data[,10],type = \"additive\"))\nplot(stl(data[,10], \"per\"))\n\n# Correlogramas\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(data[,10], main=\"Serie original\", ylab=\"Afiliados\")\nacf(data[,10], main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(data[,10], main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n# Serie diferenciada\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(diff(data[,10]), main=\"Serie diferenciada\", ylab=\"Afiliados\")\nacf(diff(data[,10]), main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(diff(data[,10]), main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n# Diferenciacion estacional\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(diff(diff(data[,10]),12), main=\"Serie diferenciada\", ylab=\"Afiliados\")\nacf(diff(diff(data[,10]),12), main=\"FAC\", ci.col=\"red\", ylab=\"ACF\",48)\npacf(diff(diff(data[,10]),12), main=\"FACP\", ci.col=\"red\", ylab=\"PACF\",48)\n\n\nauto.arima(data[,10])\nmodelo <- arima(data[,10], order=c(0,1,1),seasonal=list(order=c(0,0,1), period=12))\nmodelo\n\nproy <- forecast(modelo, h=60)\nU = proy$upper[,2]  \nL = proy$lower[,2]\n\nplot(cbind(seq(1,132), as.vector(data[,10])), xlim=c(0,160), ylim=c(0,850000), type=\"o\")\npar(new=TRUE)\nplot(cbind(seq(121,144), as.vector(proy$pred)), col=\"red\", xlim=c(0,160), ylim=c(0,850000), type=\"o\")\npar(new=TRUE)\nplot(cbind(seq(121,144), as.vector(U)), col=\"blue\", xlim=c(0,160), ylim=c(0,850000), type=\"l\", lty=\"dashed\")\npar(new=TRUE)\nplot(cbind(seq(121,144), as.vector(L)), col=\"blue\", xlim=c(0,160), ylim=c(0,850000), type=\"l\", lty=\"dashed\")\n\n\n# Graficos proyecciones - Provincias\n\n\nesti <- matrix(0, ncol=24, nrow=252)\nfor(j in 1:24){\n     modelo <- auto.arima(data[,j])\n     proy <- forecast(modelo, h=252)\n     esti[,j] <- proy$mean\n}\n\nlayout(matrix(c(1,2),1,2, byrow = TRUE))\nqqnorm(proy$residuals)\nqqline(proy$residuals)\nhist(proy$residuals, density = TRUE)\n\n\n# Escritura de pronosticos\ncolnames(esti) <- colnames(data)\ndatos <- ts(esti, start = c(2015), frequency = 12)\nwrite.csv(datos, \"proyecciones_ult.csv\")\n\n\n\n\n# Consideramos el periodo 2006 - 2015 & Afiliados total por provincia\ndata <- data %>% filter(INDEX==5, ANIO != 2016, PROVINCIA !=\"ECUADOR\", PROVINCIA !=\"PARA ACTUALIZACIÓN (DNAC)\") %>% \n     select(ANIO, PROVINCIA, NUM)\n\n# Verticalizamos la información\n#data <- spread(data, ANIO, NUM)\ndata <- spread(data, PROVINCIA, NUM)\n\n# Solo Provincias\n#data <- data %>% filter(PROVINCIA != \"PARA ACTUALIZACIÓN (DNAC)\", PROVINCIA != \"ECUADOR\")\n\ndata <- data %>% select(-ANIO)\n\n# Convertimos en serie de tiempo\ndata <- ts(data, start = c(2006))\n\nplot(data[,c(1:6)], main=\"Afiliados históricos\")\nplot(data[,c(7:12)], main=\"Afiliados históricos\")\nplot(data[,c(13:18)], main=\"Afiliados históricos\")\nplot(data[,c(19:24)], main=\"Afiliados históricos\")\n\n\nlibrary('tseries')\nlibrary('forecast')\n\nkpss.test(data[,10])\n\n# Ajuste por series temporales ARIMA\n\nmedia <- numeric()\nvarianza <- numeric()\ndife <- as.vector(diff(logdata))\nfor(i in 1:length(dife)){\n     percentil <- quantile(dife, probs = c(0.05, 0.95))\n     if(dife[i]<percentil[1]){\n          dife[i] <- percentil[1]\n     } else if (dife[i]>percentil[2]){\n          dife[i] <- percentil[2]\n     }\n}\n\nhist(dife)\n\nmatdif <- matrix(dife, ncol=24, byrow = FALSE)\n\n\n# for(k in 1:100){\n#      muestra <- sample(dife, size=216, replace = TRUE)\n#      media[k] <- mean(muestra)\n#      varianza[k] <- var(muestra)\n# }\n\n\n\n# Transformacion logaritmica\nlogdata <- data # log(data)\n\nset.seed(123)\nmatlog <- matrix(0, nrow=nrow(logdata)+25, ncol=ncol(logdata)) # +25\nmatlin <- matrix(0, nrow=nrow(logdata)+25, ncol=ncol(logdata)) # +25\nmatlog[1,] <- as.vector(logdata[1,])\nmatlin[1,] <- as.vector(logdata[1,])\nvari <- apply(matdif, 2, sd)/sqrt(10)\nmedia <- apply(matdif, 2, mean)/10\n\n\nfor(j in 1:ncol(logdata)){\n     model <- auto.arima(logdata[,j])\n     if(length(model$coef)==0){\n          beta <- 0\n     } else {\n          beta <- model$coef\n     }\n     \n     for(i in 2:(nrow(logdata)+25)){ # +25\n          matlog[i,j] <- matlog[i-1,j] + (beta + rnorm(1, mean=media[j], sd=vari[j]))*(2.5/(1+exp(i/23)))\n          matlin[i,j] <- matlin[i-1,j] + beta\n     }\n     \n}\n\nmatlog\nmatlin\n\n# Estimación 2015\nsum(matlog[10,])\n# Estimación 2025\nsum(matlog[20,])\n# Estimación 2030\nsum(matlog[25,])\n# Estimación 2035\nsum(matlog[30,])\n# Estimación 2040\nsum(matlog[35,])\n\n#logres <- ts(round(exp(matlog),0), start = c(2006))\nlogres <- ts(round(matlog,0), start = c(2006))\nmatlin <- ts(round(matlin,0), start = c(2006))\n\nplot(data[,1], ylim=c(50000, 200000), col=\"green\", ylab=\"Afiliados\")\npar(new=TRUE)\nplot(logres[,1], ylim=c(50000, 200000), col=\"red\", ylab=\"Afiliados\")\n\n\nfor(j in 1:ncol(data)){\n     titulo <- paste(\"Provincia \", colnames(data)[j])\n     minimo <- min(min(data[,j]), min(logres[,j]), min(matlin[,j]))\n     maximo <- max(max(data[,j]), max(logres[,j]), max(matlin[,j]))\n     plot(data[,j], ylim=c(minimo, maximo), xlim=c(2005, 2040), col=\"blue\", ylab=\"Afiliados\", main=titulo, lwd=2)\n     par(new=TRUE)\n     plot(logres[,j], ylim=c(minimo, maximo), xlim=c(2005, 2040), col=\"red\", ylab=\"Afiliados\", main=titulo, lwd=2)\n     par(new=TRUE)\n     plot(matlin[,j], ylim=c(minimo, maximo), xlim=c(2005, 2040), col=\"green\", ylab=\"Afiliados\", main=titulo, lwd=2, lty=3)\n}\n\ncolnames(logres) <- colnames(data)\n\n# Error en el total proyectado\n\napply(data, 2, sum)-apply(logres[1:10,], 2, sum)\nsum(apply(data, 2, sum)-apply(logres[1:10,], 2, sum))\n\n\n# Estimación 2015\nproy <- rbind(logres[10,], logres[20,], logres[25,], logres[30,], logres[35,])\nrownames(proy) <- c(\"2015\", \"2025\", \"2030\", \"2035\", \"2040\")\n\nafi <- c(3526093, 5115326, 5715049, 6385085, 7133676)\n\napply(proy, 1, sum) - afi\n\n\n\n\n##############################################################################################\n\n\ninfo <- read_excel(\"proyecciones_finales.xlsx\", sheet = 2)\n#info <- info %>% select(-AÑO)\n\n# Graficos PGR proyeccion por Provincia\nprov <- c(\"PICHINCHA\", \"GUAYAS\", \"AZUAY\")\nfor(i in 1:length(prov)){\n     plot(info[[1]][1:10], info[[prov[i]]][1:10], type='b', xlim=c(2006, 2040), ylim=c(0,0.25), col='blue',\n          ylab='Radio crecimiento', xlab='Año', main=prov[i])\n     par(new=TRUE)\n     plot(info[[1]][11:34], info[[prov[i]]][11:34], type='b', xlim=c(2006, 2040), ylim=c(0,0.25), col='red',\n          ylab='Radio crecimiento', xlab='Año', main=prov[i])\n}\n\nSGO <- read_excel(\"proyectado_SGO.xlsx\", sheet = 1)\nSGO <- SGO %>% select(AÑO, PGR) %>% filter(AÑO < 2040)\n\nplot(SGO[[1]][1:10], SGO[[2]][1:10], type='b', xlim=c(2006, 2040), ylim=c(0,0.25), col='blue',\n     ylab='Radio crecimiento', xlab='Año', main=\"Ecuador\")\npar(new=TRUE)\nplot(SGO[[1]][11:34], SGO[[2]][11:34], type='b', xlim=c(2006, 2040), ylim=c(0,0.25), col='red',\n     ylab='Radio crecimiento', xlab='Año', main=\"Ecuador\")\n\n# Graficos PGR comparacion\n\n\nplot(SGO[[1]], SGO[[2]], type='o', xlim=c(2006, 2040), ylim=c(0,0.25), col='blue',\n     ylab='Radio crecimiento', xlab='Año', main=\"Tasa de crecimiento\")\npar(new=TRUE)\nplot(info[[1]], info[[\"PICHINCHA\"]], type='o', xlim=c(2006, 2040), ylim=c(0,0.25), col='red',\n     ylab='Radio crecimiento', xlab='Año')\npar(new=TRUE)\nplot(info[[1]], info[[\"GUAYAS\"]], type='o', xlim=c(2006, 2040), ylim=c(0,0.25), col='green',\n     ylab='Radio crecimiento', xlab='Año')\n\nlegend(2025,0.22, c(\"Ecuador\", \"Pichincha\", \"Guayas\"), lty=c(1,1,1), lwd=c(2,2,2),col=c(\"blue\",\"red\",\"green\"))\n\n\n\n\n\n\n\n\n\n\n\n\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(data[,10], main=\"Serie original\", ylab=\"Afiliados\")\nacf(data[,10], main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(data[,10], main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(diff(data[,10]), main=\"Serie original\", ylab=\"Afiliados\")\nacf(diff(data[,10]), main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(diff(data[,10]), main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(diff(diff(data[,10]), 12), main=\"Serie original\", ylab=\"Afiliados\")\nacf(diff(diff(data[,10]), 12), main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(diff(diff(data[,10]), 12), main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n\nmod <- Arima(data[,10], order=c(0,1,1), seasonal = list(order=c(0,0,1), period=12))\nmod$aic\nlayout(matrix(c(1,1,2,3),2,2, byrow = TRUE))\nplot(mod$residuals, main=\"Serie original\", ylab=\"Afiliados\")\nacf(mod$residuals, main=\"FAC\", ci.col=\"red\", ylab=\"ACF\", 48)\npacf(mod$residuals, main=\"FACP\", ci.col=\"red\", ylab=\"PACF\", 48)\n\n",
    "created" : 1455293366648.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2364895506",
    "id" : "DBD41681",
    "lastKnownWriteTime" : 1455896593,
    "last_content_update" : 1455896593399,
    "path" : "~/Diego/Afiliados Provincia/Script01.R",
    "project_path" : "Script01.R",
    "properties" : {
        "notebook_format" : "pdf_document"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}